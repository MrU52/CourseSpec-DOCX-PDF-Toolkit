<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>CourseSpec ⟡ DOCX Generator</title>


  <!-- Link to your external stylesheet -->
<link rel="stylesheet" href="/style.css" />


  <!-- Fonts & Libraries -->

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.9.6/ace.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.9.6/mode-json.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.9.6/theme-tomorrow_night_bright.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>

  
</head>

<body>
  <div class="card" id="card">
  <h1><span>📄</span> Generate DOCX from JSON</h1>



  <div id="modeButtons" style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem;">
  <button type="button" class="modeBtn" data-mode="default">Use Default Template</button>
  <button type="button" class="modeBtn" data-mode="url">Use URL Template</button>
  <button type="button" class="modeBtn" data-mode="upload">Upload Template</button>
</div>


  <!-- JSON Editor -->
  <div id="editor">{ "CourseTitle": "GG", "CourseCode": "AYSM", "ContentTable": [ { "ContentTableTopic": "Intro to JS", "TopicHours": "2" } ] }</div>

  <!-- Template URL input -->
  <div id="urlField" style="margin-top: 1rem; display: none;">
  <label><b> 🔗Template URL</b></label>
</div>

  <!-- File upload input -->
<div id="fileField" style="margin-top: 1rem; display: none;">
  <label><b>📎 Upload DOCX template:</b></label>
  <input type="file" id="templateFile" accept=".docx" />
</div>



  <!-- Generate button + status -->
  <button id="generateBtn"><span>🚀</span> Generate DOCX</button>
  <div id="status"></div>
</div>






  <!-- ⬇ NEW compact upload card (900 px like the first) -->
<div class="card upload-card">
  <h1><span>📤</span> Convert DOCX to PDF</h1>

  <!-- Dropzone -->
  <div id="dropzone" class="dropzone">
    <p id="dzMessage">📂 Drop DOCX here / click to browse</p>
    <input type="file" id="fileInput" accept=".docx" hidden />
  </div>

  <!-- File info + circular progress -->
  <div class="file-row">
    <span id="fileInfo"></span>

    <svg id="progressCircle" class="circle hidden" width="48" height="48">
      <circle cx="24" cy="24" r="22" pathLength="100" />
      <text x="50%" y="50%" dy=".3em" text-anchor="middle" id="pctTxt">0%</text>
    </svg>
  </div>

  <button id="convertBtn" disabled>📎 Convert to PDF</button>
  <div id="upStatus"></div>
</div>





  <script>
    // Wait until libraries load
    window.addEventListener('load', () => {
      const editor = ace.edit("editor");
      editor.session.setMode("ace/mode/json");
      editor.setTheme("ace/theme/tomorrow_night_bright");
      editor.setOptions({ fontSize: "14px", wrap: true });
      gsap.from("#card", { opacity: 0, y: 60, duration: 1 });


const exampleJSON = {
  default: {
    CourseTitle: "GG",
    CourseCode: "AYSM",
    ContentTable: [
      { ContentTableTopic: "Intro to JS", TopicHours: "2" }
    ]
  },
  url: {
    templateUrl: "https://example.com/template.docx",
    data: {
      CourseTitle: "Web Dev",
      CourseCode: "WD101",
      ContentTable: [
        { ContentTableTopic: "HTML Basics", TopicHours: "3" }
      ]
    }
  },
  upload: {
    CourseTitle: "From Upload",
    CourseCode: "DOCX123",
    ContentTable: [
      { ContentTableTopic: "Uploaded Lesson", TopicHours: "1.5" }
    ]
  }
};

// Toggle inputs and editor content
document.querySelectorAll(".modeBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    const mode = btn.dataset.mode;

    // Toggle visibility
    document.getElementById("urlField").style.display = (mode === "url") ? "block" : "none";
    document.getElementById("fileField").style.display = (mode === "upload") ? "block" : "none";

    // Update editor content
    const example = exampleJSON[mode];
    const value = JSON.stringify(example, null, 2);
    editor.setValue(value, -1);
  });
});





      // Beautify the default JSON 
      const raw = editor.getValue();
      editor.setValue(JSON.stringify(JSON.parse(raw), null, 2), -1);

      
      // DOCX Generation Logic
      const btn = document.getElementById("generateBtn");
const status = document.getElementById("status");

btn.addEventListener("click", async () => {
  status.textContent = ""; status.className = "";
  let jsonData;

  // Parse editor input
  try {
    jsonData = JSON.parse(editor.getValue());
  } catch (e) {
    status.textContent = "❌ Invalid JSON";
    status.classList.add("error");
    return;
  }

  // Get templateUrl and file
  const templateUrl = document.getElementById("templateUrl").value.trim();
  const templateFile = document.getElementById("templateFile").files[0];

  btn.disabled = true; btn.style.opacity = ".7"; btn.textContent = "⏳ Generating…";

  try {
    let res;

    if (templateFile) {
      // 📎 Send FormData with file and JSON string
      const formData = new FormData();
      formData.append("template", templateFile);
      formData.append("data", JSON.stringify(jsonData));
      res = await fetch(`${window.location.origin}/generate-docx`, {
        method: "POST",
        body: formData
      });
    } else {
      // 🌐 Use JSON body (with or without templateUrl)
      const payload = {
        data: jsonData
      };
      if (templateUrl) payload.templateUrl = templateUrl;

      res = await fetch(`${window.location.origin}/generate-docx`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
    }

    if (!res.ok) throw new Error("Server error");

    const templateSource = res.headers.get("X-Template-Source") || "Unknown source";
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "course-spec.docx";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);

    status.innerHTML = `✅ DOCX downloaded<br>🧾 <code>${templateSource}</code>`;
    status.classList.add("success");
    confetti({ particleCount: 100, spread: 70, origin: { y: 0.85 } });

  } catch (err) {
    status.textContent = "❌ Failed to generate DOCX";
    status.classList.add("error");
  } finally {
    btn.disabled = false; btn.style.opacity = "1"; btn.textContent = "🚀 Generate DOCX";
  }
});



      

      // PDF Upload Logic
 //  ─── element refs ───────────────────────────────────────────
const dz        = document.getElementById("dropzone");
const dzMsg     = document.getElementById("dzMessage");
const fileInput = document.getElementById("fileInput");
const convertBtn= document.getElementById("convertBtn");
const fileInfo  = document.getElementById("fileInfo");
const upStatus  = document.getElementById("upStatus");
const circle    = document.getElementById("progressCircle");
const pctTxt    = document.getElementById("pctTxt");
let selectedFile;

//  ─── helpers ────────────────────────────────────────────────
const setPct = p=>{
  circle.classList.remove("hidden");
  circle.querySelector("circle").style.strokeDashoffset = 100 - p;
  pctTxt.textContent = p + "%";
  if(p===100) setTimeout(()=>circle.classList.add("hidden"), 800);
}

//  ─── drag / browse file selection ───────────────────────────
dz.addEventListener("click", ()=>fileInput.click());
["dragover","dragenter"].forEach(eName=>
  dz.addEventListener(eName,e=>{e.preventDefault();dz.classList.add("dragover");})
);
["dragleave","drop"].forEach(eName=>
  dz.addEventListener(eName,()=>dz.classList.remove("dragover"))
);
dz.addEventListener("drop", e=>{
  e.preventDefault(); handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener("change", e=>handleFile(e.target.files[0]));

function handleFile(file){
  if(!file) return;
  selectedFile = file;
  fileInfo.textContent = `📄 ${file.name} • ${(file.size/1024).toFixed(1)} KB`;
  convertBtn.disabled = false;
  setPct(0);
  upStatus.textContent="";
}

//  ─── convert to PDF ─────────────────────────────────────────
convertBtn.addEventListener("click", async ()=>{
  if(!selectedFile) return;
  const fd = new FormData(); fd.append("file", selectedFile);
  convertBtn.disabled = true; convertBtn.textContent="⏳ Converting…";
  setPct(10);                              // quick visual start

  try{
    const res = await fetch(`${window.location.origin}/upload`,{
      method:"POST", body: fd
    });
    if(!res.ok) throw new Error();

    // fake mid-progress animation (you don’t stream upload progress)
    for(const p of [40,70,90,100]) setTimeout(()=>setPct(p), 120*(p/20));

    const blob = await res.blob();
    const url  = URL.createObjectURL(blob);
    setTimeout(()=>{ // ensure bar hits 100 before download dialog
      const a=document.createElement("a");
      a.href=url; a.download="converted.pdf";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      upStatus.textContent="✅ PDF downloaded!"; upStatus.style.color="#16a34a";
    },500);

  }catch{
    upStatus.textContent="❌ Conversion failed"; upStatus.style.color="#dc2626";
    circle.classList.add("hidden");
  }finally{
    convertBtn.disabled=false; convertBtn.textContent="🔁 Convert to PDF";
  }
});


      const uploadForm = document.getElementById("uploadForm");
      const uploadBtn = document.getElementById("uploadBtn");
      const uploadStatus = document.getElementById("uploadStatus");
      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const file = uploadForm.querySelector("input[type=file]").files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("file", file);
        uploadBtn.disabled = true;
        uploadBtn.textContent = "⏳ Uploading...";
        uploadStatus.textContent = "";

        try {
          const res = await fetch(`${window.location.origin}/upload`, {
            method: "POST", body: formData
          });
          if (!res.ok) throw new Error("Conversion failed");
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url; a.download = "converted.pdf";
          document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
          uploadStatus.textContent = "✅ PDF downloaded!";
          uploadStatus.style.color = "#16a34a";
        } catch (err) {
          uploadStatus.textContent = "❌ Conversion failed";
          uploadStatus.style.color = "#dc2626";
        } finally {
          uploadBtn.disabled = false;
          uploadBtn.textContent = "📎 Upload & Convert";
        }
      });
    });
  </script>
</body>

</html>
